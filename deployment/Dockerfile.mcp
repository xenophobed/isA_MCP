# ============================================
# ISA MCP Service - Production Dockerfile
# ============================================
# Image: isa-mcp:latest
# Multi-stage build for optimized image size
# Best practices: security, performance, caching

# ============================================
# Stage 1: Builder - Install dependencies
# ============================================
FROM python:3.11-slim as builder

# Set build arguments
ARG ENVIRONMENT=production
ARG PYTHON_VERSION=3.11

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PIP_NO_CACHE_DIR=1 \
    PIP_DISABLE_PIP_VERSION_CHECK=1

# Install system dependencies required for building
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    curl \
    git \
    libpq-dev \
    wget \
    && rm -rf /var/lib/apt/lists/*

# Install uv for faster dependency installation
RUN curl -LsSf https://astral.sh/uv/install.sh | sh
ENV PATH="/root/.local/bin:$PATH"

# Create virtual environment
RUN python -m venv /opt/venv
ENV PATH="/opt/venv/bin:$PATH"

# Copy requirements files
WORKDIR /app
COPY deployment/${ENVIRONMENT}/requirements*.txt ./deployment/${ENVIRONMENT}/
COPY deployment/dev/requirements*.txt ./deployment/dev/

# Install dependencies using uv for speed
# Handle different naming conventions: requirements.txt (dev) or requirements.{env}.txt (production/staging/test)
RUN if [ -f deployment/${ENVIRONMENT}/requirements.txt ]; then \
        uv pip install --no-cache -r deployment/${ENVIRONMENT}/requirements.txt; \
    elif [ -f deployment/${ENVIRONMENT}/requirements.${ENVIRONMENT}.txt ]; then \
        uv pip install --no-cache -r deployment/${ENVIRONMENT}/requirements.${ENVIRONMENT}.txt; \
    else \
        echo "Error: No requirements file found" && exit 1; \
    fi

# Install ISA Model from pre-built wheel package
# This ensures consistent version (0.4.2) across all environments
COPY deployment/isa_model-0.4.2-py3-none-any.whl /tmp/
RUN uv pip install --no-cache "/tmp/isa_model-0.4.2-py3-none-any.whl[cloud]" && \
    rm /tmp/isa_model-0.4.2-py3-none-any.whl

# Install Playwright browsers (needed for web automation)
RUN playwright install chromium --with-deps

# ============================================
# Stage 2: Runtime - Minimal production image
# ============================================
FROM python:3.11-slim

# Set runtime arguments
ARG ENVIRONMENT=production
ARG VERSION=latest
ARG BUILD_DATE
ARG VCS_REF

# Labels for container metadata
LABEL org.opencontainers.image.title="MCP Agent Service" \
      org.opencontainers.image.description="Model Context Protocol Agent with FastMCP" \
      org.opencontainers.image.version="${VERSION}" \
      org.opencontainers.image.created="${BUILD_DATE}" \
      org.opencontainers.image.revision="${VCS_REF}" \
      org.opencontainers.image.vendor="Your Organization" \
      maintainer="your-team@example.com"

# Set environment variables
ENV PYTHONDONTWRITEBYTECODE=1 \
    PYTHONUNBUFFERED=1 \
    PYTHONPATH=/app \
    PATH="/opt/venv/bin:$PATH" \
    ENVIRONMENT=${ENVIRONMENT}

# Install only runtime dependencies
# Note: Playwright browsers need their system dependencies even in runtime
RUN apt-get update && apt-get install -y --no-install-recommends \
    libpq5 \
    curl \
    ca-certificates \
    wget \
    libnss3 \
    libnspr4 \
    libatk1.0-0 \
    libatk-bridge2.0-0 \
    libcups2 \
    libdrm2 \
    libdbus-1-3 \
    libxkbcommon0 \
    libxcomposite1 \
    libxdamage1 \
    libxfixes3 \
    libxrandr2 \
    libgbm1 \
    libasound2 \
    libatspi2.0-0 \
    libcairo2 \
    libpango-1.0-0 \
    libpangocairo-1.0-0 \
    && rm -rf /var/lib/apt/lists/*

# Create non-root user for security
RUN groupadd -r mcp && useradd -r -g mcp mcp

# Create application directory
WORKDIR /app

# Copy virtual environment from builder
COPY --from=builder /opt/venv /opt/venv

# Copy Playwright browsers from builder
COPY --from=builder /root/.cache/ms-playwright /home/mcp/.cache/ms-playwright

# Copy application code
COPY --chown=mcp:mcp . .

# Create necessary directories with correct permissions
RUN mkdir -p /app/logs /app/cache /app/data_storage && \
    chown -R mcp:mcp /app/logs /app/cache /app/data_storage /home/mcp/.cache

# Switch to non-root user
USER mcp

# Expose MCP server port
EXPOSE 8081

# Health check
HEALTHCHECK --interval=30s --timeout=10s --start-period=40s --retries=3 \
    CMD curl -f http://localhost:8081/health || exit 1

# Default command - can be overridden
CMD ["python", "main.py", "--port", "8081"]

# ============================================
# Build instructions:
# ============================================
# Navigate to project root first!
# cd /Users/xenodennis/Documents/Fun/isA_MCP
#
# Development:
#   docker build -f deployment/Dockerfile.mcp \
#     --build-arg ENVIRONMENT=dev \
#     -t mcp-service:dev .
#
# Test:
#   docker build -f deployment/Dockerfile.mcp \
#     --build-arg ENVIRONMENT=test \
#     -t mcp-service:test .
#
# Staging:
#   docker build -f deployment/Dockerfile.mcp \
#     --build-arg ENVIRONMENT=staging \
#     --build-arg VERSION=$(git describe --tags 2>/dev/null || echo "latest") \
#     --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
#     --build-arg VCS_REF=$(git rev-parse --short HEAD) \
#     -t mcp-service:staging .
#
# Production:
#   docker build -f deployment/Dockerfile.mcp \
#     --build-arg ENVIRONMENT=production \
#     --build-arg VERSION=$(git describe --tags 2>/dev/null || echo "latest") \
#     --build-arg BUILD_DATE=$(date -u +'%Y-%m-%dT%H:%M:%SZ') \
#     --build-arg VCS_REF=$(git rev-parse --short HEAD) \
#     -t mcp-service:latest .
#
# ============================================
# Run instructions:
# ============================================
# Development (with host network for Supabase/Neo4j access):
#   docker run -d \
#     --name mcp-service-dev \
#     --network host \
#     --env-file deployment/dev/.env \
#     -v $(pwd)/logs:/app/logs \
#     -v $(pwd)/cache:/app/cache \
#     mcp-service:dev
#
# Production (with port mapping):
#   docker run -d \
#     --name mcp-service \
#     -p 8081:8081 \
#     --env-file deployment/production/.env.production \
#     -v $(pwd)/logs:/app/logs \
#     -v $(pwd)/cache:/app/cache \
#     mcp-service:latest
#
# With Consul registration (production):
#   docker run -d \
#     --name mcp-service \
#     -p 8081:8081 \
#     --env-file deployment/production/.env.production \
#     -e CONSUL_HOST=consul.service.consul \
#     -e CONSUL_PORT=8500 \
#     -e REGISTER_CONSUL=true \
#     -v $(pwd)/logs:/app/logs \
#     -v $(pwd)/cache:/app/cache \
#     mcp-service:latest
#
# ============================================
# Docker Compose (recommended for test/staging/prod):
# ============================================
# Test:     docker-compose -f deployment/test/docker-compose.test.yml up -d
# Staging:  docker-compose -f deployment/staging/docker-compose.staging.yml up -d
# Production: docker-compose -f deployment/production/docker-compose.yml up -d
# ============================================
