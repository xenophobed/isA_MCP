[pytest]
# ═══════════════════════════════════════════════════════════════
# isA_MCP Test Configuration
# ═══════════════════════════════════════════════════════════════

# Python path for imports
pythonpath = .

# Test discovery paths
testpaths = tests
python_files = test_*.py
python_classes = Test*
python_functions = test_*

# Async configuration
# Note: Using session scope to work around isa_common's global asyncio.Lock()
# which is incompatible with function-scoped event loops
asyncio_mode = auto
asyncio_default_fixture_loop_scope = session
asyncio_default_test_loop_scope = session

# ═══════════════════════════════════════════════════════════════
# Test Markers
# ═══════════════════════════════════════════════════════════════
markers =
    # Test Layers
    api: API contract tests (Layer 1) - runs against MCP server
    integration: Service integration tests (Layer 2) - real DB, mocked external
    component: Component tests (Layer 3) - mocked dependencies
    unit: Unit tests (Layer 4) - pure functions, no I/O
    e2e: End-to-end tests
    eval: DeepEval LLM quality tests

    # Test Types
    golden: Characterization tests - DO NOT MODIFY (captures existing behavior)
    tdd: TDD tests for new features
    snapshot: Snapshot-based tests

    # Performance markers
    slow: Tests taking > 10 seconds
    performance: Performance benchmark tests

    # Infrastructure requirements
    requires_db: Tests requiring PostgreSQL
    requires_qdrant: Tests requiring Qdrant vector DB
    requires_minio: Tests requiring MinIO storage
    requires_redis: Tests requiring Redis cache
    requires_ai: Tests requiring AI model access (OpenAI, etc.)
    requires_network: Tests requiring network access

    # Feature markers
    llm: Tests for LLM functionality
    embedding: Tests for embedding functionality
    vision: Tests for vision/image functionality
    audio: Tests for audio functionality
    tools: Tests for tool functionality
    prompts: Tests for prompt functionality
    resources: Tests for resource functionality
    auth: Tests for authentication/authorization
    search: Tests for semantic search
    sync: Tests for synchronization
    base_tool: Tests for BaseTool class (critical infrastructure)
    skill: Tests for skill service (classification, embedding)
    aggregator: Tests for MCP server aggregator service
    smoke: Smoke tests for deployment validation

# ═══════════════════════════════════════════════════════════════
# Default Options
# ═══════════════════════════════════════════════════════════════
addopts =
    --strict-markers
    -ra
    --tb=short
    -v
    --color=yes

# Warning filters
filterwarnings =
    ignore::DeprecationWarning
    ignore::PendingDeprecationWarning
    ignore::pytest.PytestUnraisableExceptionWarning

# ═══════════════════════════════════════════════════════════════
# Timeout Configuration
# ═══════════════════════════════════════════════════════════════
timeout = 300

# ═══════════════════════════════════════════════════════════════
# Logging Configuration
# ═══════════════════════════════════════════════════════════════
log_cli = false
log_cli_level = WARNING
log_cli_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_cli_date_format = %Y-%m-%d %H:%M:%S

log_file = test.log
log_file_level = DEBUG
log_file_format = %(asctime)s [%(levelname)s] %(name)s: %(message)s
log_file_date_format = %Y-%m-%d %H:%M:%S
