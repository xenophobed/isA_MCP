# Web Crawl Tool

## Description
Intelligently crawl and analyze web pages using a **hybrid approach with enhanced extraction**: BS4 extraction with comprehensive structured data support (default) with VLM analysis fallback, all enhanced by LLM synthesis. Supports both single URL analysis and multiple URL comparison.

### Architecture
1. **Default**: BS4 extraction using `bs4_service` 
   - **Basic Mode**: Fast text extraction (no analysis request)
   - **Enhanced Mode**: Full structured data extraction (with analysis request)
2. **Fallback**: VLM analysis using `image_analyzer` (comprehensive visual understanding)
3. **Enhancement**: LLM synthesis using `text_generator` (intelligent analysis and reporting)

## Input Parameters
- `url` (string, required): Target web page URL or JSON array of URLs for comparison
- `analysis_request` (string, optional): Analysis request description (default: "")

### URL Formats
- Single URL: `"https://example.com"`
- Multiple URLs: `'[\"https://site1.com\", \"https://site2.com\"]'` (JSON array as string)

### Input Validation
- JSON arrays must contain only string URLs (numbers or other types rejected)
- Empty arrays `[]` are rejected
- JSON objects `{}` are rejected (only arrays supported for multiple URLs)
- Malformed JSON triggers validation errors

## Output Format

### Single URL Analysis
```json
{
  "status": "success|error",
  "action": "web_crawl",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "success": true,
    "result": {
      "method": "bs4_extraction|bs4_extraction_enhanced|vlm_analysis",
      "success": true,
      "content": "Clean extracted text content...",
      "title": "Page Title",
      "headings": [
        {"level": "h1", "text": "Main Heading"},
        {"level": "h2", "text": "Sub Heading"}
      ],
      "paragraphs": ["First paragraph...", "Second paragraph..."],
      "links": [
        {"text": "Link Text", "url": "https://example.com"}
      ],
      "word_count": 150,
      "processing_time": 0.45,
      "final_report": "Intelligent analysis report generated by LLM...",
      
      // Enhanced mode additional fields (when analysis_request provided)
      "tables": [{"headers": ["Col1", "Col2"], "rows": [["data1", "data2"]]}],
      "images": [{"src": "image.jpg", "alt": "Description", "width": 300, "height": 200}],
      "videos": [{"src": "video.mp4", "type": "html5"}],
      "code_blocks": [{"content": "print('hello')", "language": "python"}],
      "lists": {"ordered": [], "unordered": ["item1", "item2"]},
      "forms": [{"action": "/search", "method": "GET", "fields": [{"name": "q", "type": "text"}]}],
      "metadata": {
        "og:title": "Open Graph Title",
        "og:description": "Description",
        "author": "Author Name",
        "keywords": "keyword1, keyword2"
      },
      "seo_analysis": {
        "title_length": 35,
        "title_ok": true,
        "meta_description": "Page description",
        "h1_count": 1,
        "h2_count": 5,
        "internal_links": 45,
        "external_links": 12,
        "schema_org": true
      },
      "readability_score": {
        "flesch_reading_ease": 35.2,
        "total_sentences": 50,
        "total_words": 388,
        "avg_words_per_sentence": 15.5
      },
      "extraction_stats": {
        "headings": 9,
        "paragraphs": 9,
        "links": 47,
        "tables": 1,
        "images": 1,
        "videos": 0,
        "code_blocks": 14,
        "forms": 1,
        "ordered_lists": 0,
        "unordered_lists": 28,
        "words": 388
      },
      
      "raw_data": {
        "title": "Page Title",
        "content": "Content preview...",
        "headings_count": 2,
        "paragraphs_count": 3,
        "links_count": 1,
        // Enhanced mode stats
        "tables_count": 1,
        "images_count": 1,
        "videos_count": 0,
        "code_blocks_count": 14,
        "forms_count": 1
      }
    },
    "url": "https://example.com",
    "analysis_request": "extract main content",
    "extraction_method": "bs4_extraction_enhanced"
  }
}
```

### Multiple URL Comparison
```json
{
  "status": "success|error", 
  "action": "web_crawl_compare",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {
    "success": true,
    "comparison_report": "Comprehensive comparison analysis generated by LLM...",
    "urls_count": 2,
    "analysis_request": "compare product features",
    "urls": ["https://site1.com", "https://site2.com"],
    "processing_time_ms": 3500,
    "individual_results": [
      {
        "url": "https://site1.com",
        "item_index": 1,
        "analysis_result": {...},
        "success": true
      }
    ]
  }
}
```

### Result Object Structure

#### BS4 Extraction Result - Basic Mode (no analysis_request)
- **`method`**: "bs4_extraction"
- **`success`**: Boolean indicating extraction success
- **`content`**: Clean text content extracted with BeautifulSoup
- **`title`**: Page title
- **`headings`**: Array of heading objects with level and text
- **`paragraphs`**: Array of meaningful paragraph text
- **`links`**: Array of link objects with text and URL
- **`word_count`**: Total word count of extracted content
- **`processing_time`**: Time taken in seconds (typically 0.5-1.0s)
- **`raw_data`**: Summary metadata

#### BS4 Extraction Result - Enhanced Mode (with analysis_request)
All basic fields plus:
- **`method`**: "bs4_extraction_enhanced"
- **`tables`**: Array of structured table data with headers and rows
- **`images`**: Array of image objects with src, alt, dimensions
- **`videos`**: Array of video objects (HTML5 and iframe embeds)
- **`code_blocks`**: Array of detected code with language hints
- **`lists`**: Object containing ordered and unordered lists
- **`forms`**: Array of form structures with fields
- **`metadata`**: OpenGraph, Twitter Cards, JSON-LD structured data
- **`seo_analysis`**: Comprehensive SEO metrics (title, meta, h1/h2, links, schema)
- **`readability_score`**: Flesch Reading Ease score and interpretation
- **`extraction_stats`**: Counts of all extracted elements
- **`final_report`**: LLM-generated analysis report
- **`processing_time`**: Time taken in seconds (typically 0.8-1.5s)

#### VLM Analysis Result (Fallback)
- **`method`**: "vlm_analysis"
- **`success`**: Boolean indicating analysis success
- **`content`**: Rich analysis results from image analyzer
- **`model_used`**: AI model used for analysis
- **`processing_time`**: Time taken in seconds
- **`final_report`**: LLM-enhanced analysis report
- **`raw_data`**: Analysis metadata including model and timing info

## Error Response
```json
{
  "status": "error",
  "action": "web_crawl",
  "timestamp": "2024-01-01T12:00:00Z",
  "data": {},
  "error": "Error description"
}
```

## Example Usage
```python
# Single URL analysis
result = await client.call_tool("web_crawl", {
    "url": "https://example.com/article",
    "analysis_request": "extract main content and key points"
})

# Multiple URL comparison
result = await client.call_tool("web_crawl", {
    "url": '[\"https://site1.com\", \"https://site2.com\"]',
    "analysis_request": "compare product features and pricing"
})

# Simple crawl without specific analysis
result = await client.call_tool("web_crawl", {
    "url": "https://example.com"
})
```

## Method Selection

### BS4 Extraction - Basic Mode (Default without analysis)
**Used for:** Simple text extraction without analysis request

**Process:**
1. Fetch HTML content with requests
2. Parse with BeautifulSoup
3. Extract text, headings, paragraphs, links
4. Return structured text data

**Benefits:**
- ‚ö° **Ultra-fast**: 0.5-1.0 seconds (tested)
- üí∞ **Cost-effective**: No AI model calls
- üéØ **Reliable**: Consistent, deterministic results
- üßπ **Clean**: Well-structured text output

### BS4 Extraction - Enhanced Mode (With analysis request)
**Used for:** When analysis_request is provided

**Process:**
1. Fetch HTML content with requests
2. Parse with BeautifulSoup
3. Extract comprehensive structured data:
   - Tables with preserved structure
   - Images with metadata
   - Videos (HTML5 and iframes)
   - Code blocks with language detection
   - Forms and fields
   - Lists (ordered/unordered)
   - Metadata (OpenGraph, Twitter, JSON-LD)
4. Perform SEO analysis
5. Calculate readability scores
6. Generate LLM analysis report

**Benefits:**
- ‚ö° **Fast**: 0.8-1.5 seconds (tested)
- üìä **Comprehensive**: Full structured data extraction
- üîç **SEO Analysis**: Complete SEO metrics
- üìñ **Readability**: Flesch score and interpretation
- üéØ **Smart**: Automatic language detection for code
- üìà **Statistics**: Detailed extraction counts

### VLM Analysis (Fallback)
**Used when:** BS4 extraction fails or content is non-HTML

**Process:**
1. Launch browser with Playwright
2. Take screenshot of rendered page
3. Analyze with VLM using `image_analyzer`
4. Generate enhanced report with `text_generator`

**Benefits:**
- üß† **Intelligent**: Understands visual content layout
- üîÑ **Comprehensive**: Handles any page type including SPAs
- üì± **Modern**: Works with dynamic JavaScript content
- üé® **Visual**: Can analyze images, charts, complex layouts

### Automatic Selection Logic
```python
# Simplified decision logic
if is_html_content(url):
    result = bs4_extraction(url)      # Default: Fast BS4
    if bs4_result.success:
        return bs4_result
    else:
        return vlm_analysis(url)      # Fallback: Comprehensive VLM
else:
    return vlm_analysis(url)          # Non-HTML: Use VLM
```

## Architecture Components

### Core Services
1. **`bs4_service.py`** - Clean BeautifulSoup text extraction
2. **`image_analyzer.py`** - Generic VLM analysis (atomic function)
3. **`text_generator.py`** - LLM synthesis and analysis (atomic function)

### Processing Flow
```
URL Input ‚Üí BS4 Extraction ‚Üí [Success?] ‚Üí LLM Analysis ‚Üí Final Report
             ‚Üì [Failure]
         VLM Analysis ‚Üí LLM Enhancement ‚Üí Final Report
```

## Performance Characteristics

### BS4 Extraction (Default)
- **Speed**: 1-3 seconds
- **Cost**: Free (no AI calls for extraction)
- **Accuracy**: High for static content
- **Output**: Structured text data + optional LLM analysis

### VLM Analysis (Fallback)
- **Speed**: 5-15 seconds (tested and verified)
- **Cost**: AI model usage costs
- **Accuracy**: High for all content types
- **Output**: Rich visual analysis + LLM enhancement

### Multi-URL Comparison
- **Speed**: 3-10 seconds per URL + comparison synthesis
- **Cost**: Extraction costs + LLM synthesis
- **Output**: Individual results + comprehensive comparison report

## Real Test Results

### Test 1: Basic Extraction (example.com)
```
Method: bs4_extraction
Word count: 30
Processing time: ~1.0s
Features: Basic text, headings, paragraphs, links
```

### Test 2: Enhanced Extraction (example.com with analysis)
```
Method: bs4_extraction_enhanced
Word count: 30
Processing time: ~1.2s
Enhanced features extracted:
- Tables: 0
- Images: 0
- Videos: 0
- Code blocks: 0
- Forms: 0
- Metadata: 6 fields
- SEO Analysis:
  - Title length: 14 chars (too short)
  - Meta description: Missing
  - H1 count: 1
  - H2 count: 0
  - Internal links: 0
  - External links: 1
  - Schema.org: No
- Readability: College level
```

### Test 3: Complex Site Analysis (Python.org)
```
Method: bs4_extraction_enhanced
Word count: 388
Processing time: 0.94s
Extraction Statistics:
- Headings: 9
- Paragraphs: 9
- Links: 47
- Tables: 1
- Images: 1 (100% with alt text)
- Videos: 0
- Code blocks: 14
- Forms: 1 (search form with 2 fields)
- Ordered lists: 0
- Unordered lists: 28

SEO Analysis:
- Title length: 21 chars (suboptimal)
- Meta description: 52 chars (present)
- H1 tags: 6
- H2 tags: 9
- Internal links: 16
- External links: 31
- Schema.org: ‚úÖ Present

Readability:
- Flesch Reading Ease: 35.2
- Grade level: College
- Avg words/sentence: 15.5
```

### Test 4: Multi-URL Comparison (Python vs Node.js vs Rust)
```
URLs analyzed: 3
Total processing time: ~8 seconds

Python.org:
- Method: bs4_extraction_enhanced
- Word count: 388
- Tables: 1, Images: 1, Forms: 1, Code blocks: 14
- SEO: Title 21 chars, H1: 6, Schema.org: ‚úÖ

Node.js.org:
- Method: bs4_extraction_enhanced
- Word count: 169
- Tables: 0, Images: 0, Forms: 0, Code blocks: 1
- SEO: Title 35 chars, H1: 1, Schema.org: ‚ùå

Rust-lang.org:
- Method: bs4_extraction_enhanced
- Word count: 391
- Tables: 0, Images: 9, Forms: 0, Code blocks: 0
- SEO: Title 25 chars, H1: 1, Schema.org: ‚ùå

Comparison Report: AI-generated comprehensive analysis comparing:
- Homepage structure and navigation
- Documentation approach
- Community features
- SEO strategies
- Content organization
```